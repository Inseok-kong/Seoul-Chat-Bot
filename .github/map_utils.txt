from geopy.geocoders import Nominatim
import folium
from streamlit_folium import st_folium

# ğŸ“ ì¥ì†Œ ì´ë¦„ì—ì„œ ìœ„ë„/ê²½ë„ ì¶”ì¶œ
def get_coordinates(place_name):
    try:
        geolocator = Nominatim(user_agent="seoul-cultural-chatbot")
        location = geolocator.geocode("ì„œìš¸ " + place_name)
        if location:
            return (location.latitude, location.longitude)
    except:
        return None

# ğŸ“Œ ë‹µë³€ì—ì„œ ì¥ì†Œ ì´ë¦„ ì¶”ì¶œ (ê°„ë‹¨í•œ í‚¤ì›Œë“œ í•„í„°ë§ ê¸°ë°˜)
def extract_locations(text):
    keywords = ["ì„œìš¸", "í•œê°•", "ê³µì›", "ê±°ë¦¬", "ê´‘ì¥", "íƒ€ì›Œ", "ê¶", "ì‹œì¥", "ì„±ë‹¹", "ëª…ì†Œ", "ë¬¸í™”", "ì•¼ê²½", "ì „ì‹œ"]
    lines = text.split("\n")
    results = []
    for line in lines:
        if any(keyword in line for keyword in keywords):
            results.append(line.strip())
    return results[:5]

# ğŸ—ºï¸ ì¥ì†Œ ëª©ë¡ê³¼ ì¶œë°œì§€ë¥¼ ë°›ì•„ì„œ ì§€ë„ í‘œì‹œ + ê²½ë¡œ ì—°ê²°
def show_locations_on_map(places, start_point=None):
    locations = []

    # ì¶œë°œì§€ ë¨¼ì € ì¶”ê°€
    if start_point:
        start_coords = get_coordinates(start_point)
        if start_coords:
            locations.append(("ì¶œë°œì§€", start_coords))

    # ì¥ì†Œëª… â†’ ì¢Œí‘œ ë³€í™˜
    for place in places:
        coords = get_coordinates(place)
        if coords:
            locations.append((place, coords))

    if not locations:
        return

    # ì§€ë„ ìƒì„± (ì²« ë²ˆì§¸ ì¢Œí‘œë¥¼ ì¤‘ì‹¬ìœ¼ë¡œ)
    center = locations[0][1]
    m = folium.Map(location=center, zoom_start=13)

    # ë§ˆì»¤ ì¶”ê°€
    for i, (name, coord) in enumerate(locations):
        icon_color = "green" if i == 0 and start_point else "blue"
        folium.Marker(location=coord, tooltip=name, icon=folium.Icon(color=icon_color)).add_to(m)

    # ê²½ë¡œ ì„  ì—°ê²°
    if len(locations) >= 2:
        folium.PolyLine([loc[1] for loc in locations], color="blue", weight=3).add_to(m)

    # Streamlitì— í‘œì‹œ
    st_folium(m, width=700, height=500)
