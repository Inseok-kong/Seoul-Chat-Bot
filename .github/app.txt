import streamlit as st
import pandas as pd
import time
import requests
from rag import get_rag_answer_stream
from persona import create_persona
from translate import translate_text
from map_utils import extract_locations, show_locations_on_map
from chat_logger import log_chat
import folium
from streamlit_folium import st_folium

# ----- MBTI ì„¤ëª… ë”•ì…”ë„ˆë¦¬ -----
mbti_traits = {
    "ISTJ": "ì¡°ìš©í•˜ê³  ì±…ì„ê°ì´ ê°•í•˜ë©° ì¡°ì§ì ì…ë‹ˆë‹¤.",
    "ISFJ": "ì„±ì‹¤í•˜ê³  í˜‘ì¡°ì ì´ë©° íƒ€ì¸ì„ ë•ëŠ” ê²ƒì„ ì¢‹ì•„í•©ë‹ˆë‹¤.",
    "INFJ": "í†µì°°ë ¥ ìˆê³  ì¡°ìš©í•œ ì´ìƒì£¼ì˜ìì…ë‹ˆë‹¤.",
    "INTJ": "ì „ëµì  ì‚¬ê³ ì™€ ë…ë¦½ì‹¬ì´ ê°•í•œ í˜ì‹ ê°€ì…ë‹ˆë‹¤.",
    "ISTP": "ë…¼ë¦¬ì ì´ë©° ì‹¤ìš©ì ì¸ ë¬¸ì œ í•´ê²°ìì…ë‹ˆë‹¤.",
    "ISFP": "ì°¨ë¶„í•˜ê³  ì˜¨í™”í•˜ë©° ê°ì„±ì ì¸ ì„±í–¥ì´ ìˆìŠµë‹ˆë‹¤.",
    "INFP": "ì´ìƒê³¼ ê°€ì¹˜ë¥¼ ì¤‘ì‹œí•˜ë©° ê³µê° ëŠ¥ë ¥ì´ ë›°ì–´ë‚©ë‹ˆë‹¤.",
    "INTP": "íƒêµ¬ì‹¬ ë§ê³  ë¶„ì„ì ì´ë©° ë…ì°½ì ì¸ ì‚¬ìƒ‰ê°€ì…ë‹ˆë‹¤.",
    "ESTP": "ì—ë„ˆì§€ ë„˜ì¹˜ê³  í˜„ì‹¤ì ì¸ í™œë™ê°€ì…ë‹ˆë‹¤.",
    "ESFP": "ì‚¬êµì ì´ê³  ê°ê°ì ì´ë©° ì¦ê±°ì›€ì„ ì¶”êµ¬í•©ë‹ˆë‹¤.",
    "ENFP": "ì—´ì •ì ì´ê³  ì°½ì˜ì ì´ë©° íƒ€ì¸ì„ ì˜ ì´ë•ë‹ˆë‹¤.",
    "ENTP": "ë„ì „ì ì´ê³  ì¬ì¹˜ ìˆìœ¼ë©° ì°½ì˜ì ì¸ ë¬¸ì œ í•´ê²°ìì…ë‹ˆë‹¤.",
    "ESTJ": "ì²´ê³„ì ì´ê³  ì‹¤ìš©ì ì¸ ê´€ë¦¬ìì…ë‹ˆë‹¤.",
    "ESFJ": "ë”°ëœ»í•˜ê³  ì¹œê·¼í•˜ë©° íƒ€ì¸ì„ ë•ëŠ” ë° ìµìˆ™í•©ë‹ˆë‹¤.",
    "ENFJ": "ì´íƒ€ì ì´ê³  ë¦¬ë”ì‹­ì´ ë›°ì–´ë‚œ ìœ í˜•ì…ë‹ˆë‹¤.",
    "ENTJ": "ì•¼ë§ ìˆê³  ê²°ì •ë ¥ì´ ë›°ì–´ë‚œ ì „ëµê°€ì…ë‹ˆë‹¤."
}

def mbti_description(mbti):
    return mbti_traits.get(mbti, "")

# í˜ì´ì§€ ì„¤ì • ë° ì‚¬ìš©ì ìƒíƒœ ì´ˆê¸°í™”
st.set_page_config(page_title="ì„œìš¸ ë¬¸í™” ì¶”ì²œ ì±—ë´‡", layout="wide")
if "chat_history" not in st.session_state:
    st.session_state.chat_history = []

# ----- UI ì„¤ì • -----
st.markdown("""
    <style>
    .main {background-color: #f9f9f9; font-family: 'Nanum Gothic', sans-serif;}
    .stTextInput > div > div > input {font-size: 16px;}
    .stSelectbox > div > div > div {font-size: 16px;}
    </style>
""", unsafe_allow_html=True)

st.title("ğŸ¨ ì„œìš¸ ë¬¸í™” íƒí—˜ ì±—ë´‡")
st.markdown("ì„œìš¸ì‹œì˜ ì•¼ê²½, ìŒì‹, ê´€ê´‘ì§€, ë¬¸í™”í–‰ì‚¬ì— ëŒ€í•´ ê¶ê¸ˆí•œ ê±¸ ë¬¼ì–´ë³´ì„¸ìš”!")

# ----- ì‚¬ì´ë“œë°”: ì‚¬ìš©ì ì •ë³´ ë°›ê¸° -----
st.sidebar.header("ğŸ“Œ ë‹¹ì‹ ì— ëŒ€í•´ ì•Œë ¤ì£¼ì„¸ìš”")
mbti = st.sidebar.selectbox("MBTI (ì„ íƒ)", ["ëª¨ë¦„"] + list(mbti_traits.keys()))
gender = st.sidebar.selectbox("ì„±ë³„", ["ë‚¨ì„±", "ì—¬ì„±"])
age = st.sidebar.selectbox("ë‚˜ì´ëŒ€", ["10ëŒ€", "20ëŒ€", "30ëŒ€", "40ëŒ€", "50ëŒ€ ì´ìƒ"])
region = st.sidebar.selectbox("ê±°ì£¼ ì§€ì—­", ["ì„œìš¸", "ìˆ˜ë„ê¶Œ(ì„œìš¸ ì™¸ ê²½ê¸°/ì¸ì²œ)", "ê·¸ ì™¸ ì§€ì—­"])
language = st.sidebar.selectbox("ë‹µë³€ ë°›ì„ ì–¸ì–´", ["í•œêµ­ì–´", "English", "æ—¥æœ¬èª", "ä¸­æ–‡"])

use_location = st.sidebar.checkbox("í˜„ì¬ ìœ„ì¹˜ë¥¼ ì§ˆë¬¸ì— ë°˜ì˜í• ê¹Œìš”?")
location = st.sidebar.text_input("í˜„ì¬ ìœ„ì¹˜ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ì˜ˆ: ê°•ë‚¨êµ¬)") if use_location else ""

# ----- ëŒ€í™” ê¸°ë¡ì„ ì‚¬ì´ë“œë°”ì— í‘œì‹œ -----
st.sidebar.markdown("## ğŸ“œ ëŒ€í™” ê¸°ë¡")
for q, a in st.session_state.chat_history:
    st.sidebar.markdown(f"**ğŸ™‹ ì§ˆë¬¸:** {q}")
    st.sidebar.markdown(f"**ğŸ¤– ë‹µë³€:** {a}")

# ----- Persona ìƒì„± -----
persona = create_persona(gender, age, region)
if mbti != "ëª¨ë¦„":
    persona += f"\nMBTI ì„±í–¥ì€ {mbti}ì…ë‹ˆë‹¤. {mbti_description(mbti)}"
st.sidebar.markdown(f"ğŸ§ **[ë‹¹ì‹ ì˜ Persona]**\n{persona}")

# ----- ì±„íŒ… ì˜ì—­ -----
st.markdown("## ğŸ’¬ ëŒ€í™” ê¸°ë¡")
for q, a in st.session_state.chat_history:
    st.markdown(f"**ğŸ™‹ ì§ˆë¬¸:** {q}")
    st.markdown(f"**ğŸ¤– ë‹µë³€:** {a}")

# ----- ìƒˆë¡œìš´ ì§ˆë¬¸ ì…ë ¥ -----
st.markdown("## ğŸ¤” ì´ì–´ì„œ ì§ˆë¬¸í•˜ê¸°")
question = st.text_input("ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”", key="new_question")
submit = st.button("ì „ì†¡")

# ----- ì§ˆë¬¸ ì²˜ë¦¬ ë° ì‘ë‹µ -----
if submit and question:
    with st.spinner("ë‹µë³€ì„ ìƒì„± ì¤‘ì…ë‹ˆë‹¤..."):
        translated_question = translate_text(question, language)
        stream_generator = get_rag_answer_stream(translated_question, persona, use_location, location)

        streamed_text = ""
        answer_placeholder = st.empty()
        for chunk in stream_generator:
            streamed_text += chunk
            answer_placeholder.markdown(f"<div style='font-size:18px; line-height:1.6;'>{streamed_text}</div>", unsafe_allow_html=True)

        translated_answer = translate_text(streamed_text, language)
        log_chat(question, translated_answer, language)

        # ì±„íŒ… ê¸°ë¡ì— ì¶”ê°€
        st.session_state.chat_history.append((question, translated_answer))

        # ì§€ë„ ì‹œê°í™”
        places = extract_locations(translated_answer)
        if places:
            st.markdown("### ğŸ—ºï¸ ì¶”ì²œ ì¥ì†Œ ì§€ë„ ë° ê²½ë¡œ")

            # ë„¤ì´ë²„ ì§€ë„ APIë¥¼ ì‚¬ìš©í•˜ì—¬ ì¥ì†Œ ê²€ìƒ‰ í›„ ìœ„ì¹˜ í‘œì‹œ
            CLIENT_ID = "ncp_iam_BPAMKRw7t4ieo5EHZpnY"  # ë„¤ì´ë²„ API í´ë¼ì´ì–¸íŠ¸ ID
            CLIENT_SECRET = "ncp_iam_BPKMKR4N2T4LhfU2SHeIerRCJqpjKJ5QF0"  # ë„¤ì´ë²„ API ì‹œí¬ë¦¿

            def search_place(query):
                url = f"https://openapi.naver.com/v1/search/local.json?query={query}&display=1"
                headers = {
                    "X-Naver-Client-Id": CLIENT_ID,
                    "X-Naver-Client-Secret": CLIENT_SECRET,
                }
                response = requests.get(url, headers=headers)
                return response.json()

            def get_coordinates(place_data):
                if place_data['items']:
                    latitude = place_data['items'][0]['mapy']
                    longitude = place_data['items'][0]['mapx']
                    return latitude, longitude
                else:
                    return None, None

            # ì§€ë„ ìƒì„± ë° ì¥ì†Œ ê²½ë¡œ í‘œì‹œ
            m = folium.Map(location=[37.5665, 126.978], zoom_start=13)  # ì„œìš¸ì„ ê¸°ë³¸ ìœ„ì¹˜ë¡œ ì„¤ì •
            last_coords = None

            for place in places:
                place_data = search_place(place)
                lat, lon = get_coordinates(place_data)

                if lat and lon:
                    folium.Marker([lat, lon], popup=place).add_to(m)
                    if last_coords:
                        folium.PolyLine([last_coords, (lat, lon)], color="blue", weight=3).add_to(m)
                    last_coords = (lat, lon)

            # ì§€ë„ ì¶œë ¥
            st_folium(m, width=700, height=500)
